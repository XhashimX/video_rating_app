# -*- coding: utf-8 -*-
import os
import re

# ==============================================================================
# 1. ุงูุฅุนุฏุงุฏุงุช - ุฃุณูุงุก ุงููููุงุช ุงููุณุชุฎุฏูุฉ
# ==============================================================================

# ุงุณู ููู ุงูุฅุฏุฎุงู ุงูุฐู ูุญุชูู ุนูู ุฑูุงุจุท ุชูู ุชูู ุงููุงููุฉ
INPUT_FILE = "unique_links_to_download.txt"

# ุงุณู ููู ุงููุฎุฑุฌุงุช ุงูุฐู ุณูุชู ุฅุถุงูุฉ ุงูุจูุงูุงุช ุฅููู
OUTPUT_FILE = "video_ids_output.txt"


# ==============================================================================
# 2. ุงูุฏูุงู ุงููุณุงุนุฏุฉ
# ==============================================================================

def extract_info_from_url(url: str) -> tuple[str, str] | None:
    """
    ูุณุชุฎุฑุฌ ุงุณู ุงููุณุชุฎุฏู ูุฑูู ุงูููุฏูู ูู ุฑุงุจุท ุชูู ุชูู ูุงูู.
    ูุซุงู: '.../@username/video/12345' -> ('12345', 'username')
    """
    # ุงูุชุนุจูุฑ ุงูููุทู (Regex) ููุจุญุซ ุนู ุงูููุท ุงููุญุฏุฏ ูู ุงูุฑุงุจุท
    # /@([^/]+) : ูุฌุฏ ุนูุงูุฉ @ ุซู ููุชูุท ูู ุงูุญุฑูู ุงูุชุงููุฉ ุญุชู ูุตู ุฅูู ุนูุงูุฉ / (ูุฐุง ูู ุงุณู ุงููุณุชุฎุฏู)
    # /video/(\d+) : ูุฌุฏ ูููุฉ video/ ุซู ููุชูุท ูู ุงูุฃุฑูุงู ุงูุชุงููุฉ (ูุฐุง ูู ุฑูู ุงูููุฏูู)
    match = re.search(r'/@([^/]+)/video/(\d+)', url)
    
    if match:
        username = match.group(1)
        video_id = match.group(2)
        return (video_id, username)
    
    return None

def load_existing_output_ids(output_file: str) -> set:
    """
    ููุฑุฃ ููู ุงููุฎุฑุฌุงุช ุงูุญุงูู ููุฌูุน ูู ุฃุฑูุงู ุงูู ID ุงูููุฌูุฏุฉ ููู ุจุงููุนู
    ูุชุฌูุจ ุฅุถุงูุชูุง ูุฑุฉ ุฃุฎุฑู.
    """
    existing_ids = set()
    if os.path.exists(output_file):
        try:
            with open(output_file, 'r', encoding='utf-8') as f:
                for line in f:
                    if ' : ' in line:
                        video_id = line.split(' : ', 1)[0].strip()
                        if video_id:
                            existing_ids.add(video_id)
        except Exception as e:
            print(f"ุชุญุฐูุฑ: ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุฑุงุกุฉ ููู ุงููุฎุฑุฌุงุช ุงูุญุงูู: {e}")
    return existing_ids

# ==============================================================================
# 3. ุงูุณูุฑุจุช ุงูุฑุฆูุณู
# ==============================================================================

def main():
    """ุงููุธููุฉ ุงูุฑุฆูุณูุฉ ูุชุดุบูู ุงูุณูุฑุจุช"""
    print("=" * 60)
    print("๐ ุจุฏุก ุนูููุฉ ุงุณุชุฎุฑุงุฌ ID ูุงุณู ุงููุณุชุฎุฏู ูู ุงูุฑูุงุจุท")
    print("=" * 60)

    # --- ุงูุฎุทูุฉ 1: ุงูุชุญูู ูู ูุฌูุฏ ููู ุงูุฅุฏุฎุงู ---
    if not os.path.isfile(INPUT_FILE):
        print(f"โ ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ููู ุงูุฅุฏุฎุงู '{INPUT_FILE}'.")
        print("ูุฑุฌู ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงูููู ูู ููุณ ุงููุฌูุฏ.")
        return

    # --- ุงูุฎุทูุฉ 2: ุชุญููู ุงูู IDs ุงูููุฌูุฏุฉ ุจุงููุนู ูู ููู ุงููุฎุฑุฌุงุช ูุชุฌูุจ ุงูุชูุฑุงุฑ ---
    existing_ids = load_existing_output_ids(OUTPUT_FILE)
    print(f"๐ ุชู ุงูุนุซูุฑ ุนูู {len(existing_ids)} ูุฏุฎู ููุฌูุฏ ุจุงููุนู ูู '{OUTPUT_FILE}'. ุณูุชู ุชุฌุงูููุง ุฅุฐุง ุชูุฑุฑุช.")

    # --- ุงูุฎุทูุฉ 3: ูุฑุงุกุฉ ููู ุงูุฑูุงุจุท ููุนุงูุฌุชู ---
    print(f"\n๐ ุฌุงุฑู ูุฑุงุกุฉ ุงูุฑูุงุจุท ูู '{INPUT_FILE}'...")
    
    new_entries_found = []
    links_processed = 0
    links_skipped = 0
    
    try:
        with open(INPUT_FILE, 'r', encoding='utf-8') as f:
            for line in f:
                links_processed += 1
                url = line.strip()
                if not url:
                    continue

                info = extract_info_from_url(url)
                
                if info:
                    video_id, username = info
                    # ุงูุชุญูู ูู ุฃู ูุฐุง ุงูู ID ููุณ ููุฌูุฏุงู ุจุงููุนู
                    if video_id not in existing_ids:
                        new_entries_found.append((video_id, username))
                        # ูุถููู ุฅูู ุงููุงุฆูุฉ ุงูุญุงููุฉ ุฃูุถุงู ููุชุฌูุจ ุชูุฑุงุฑู ูู ูุงู ููุฌูุฏุงู ูุฑุชูู ูู ููู ุงูุฅุฏุฎุงู
                        existing_ids.add(video_id) 
                    else:
                        links_skipped += 1
                else:
                    print(f"   โ๏ธ ุชุญุฐูุฑ: ุชู ุชุฌุงูู ุงูุณุทุฑ '{url}' ูุฃูู ูุง ูุทุงุจู ุงูุตูุบุฉ ุงููุชููุนุฉ.")

    except Exception as e:
        print(f"โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุฑุงุกุฉ ููู ุงูุฅุฏุฎุงู: {e}")
        return

    print(f"โ๏ธ ุงูุชูุช ุงููุฑุงุกุฉ. ุชู ูุนุงูุฌุฉ {links_processed} ุฑุงุจุท.")
    if links_skipped > 0:
        print(f"   - ุชู ุชุฌุงูู {links_skipped} ุฑุงุจุท ูุฃููุง ููุฌูุฏุฉ ุจุงููุนู ูู ุงููุฎุฑุฌุงุช.")
    
    # --- ุงูุฎุทูุฉ 4: ูุชุงุจุฉ ุงููุชุงุฆุฌ ุงูุฌุฏูุฏุฉ ูู ููู ุงููุฎุฑุฌุงุช ---
    if not new_entries_found:
        print("\nโ ูุง ุชูุฌุฏ ุจูุงูุงุช ุฌุฏูุฏุฉ ูุฅุถุงูุชูุง. ุงูููู ูุญุฏุซ ุจุงููุนู!")
    else:
        print(f"\n๐พ ุฌุงุฑู ุฅุถุงูุฉ {len(new_entries_found)} ูุฏุฎู ุฌุฏูุฏ ุฅูู '{OUTPUT_FILE}'...")
        try:
            # ููุชุญ ุงูููู ูู ูุถุน ุงูุฅุถุงูุฉ 'a' (append)
            with open(OUTPUT_FILE, 'a', encoding='utf-8') as f:
                for video_id, username in new_entries_found:
                    f.write(f"{video_id} : {username}\n")
            print(f"โ๏ธ ุชูุช ุฅุถุงูุฉ {len(new_entries_found)} ูุฏุฎู ุฌุฏูุฏ ุจูุฌุงุญ.")
        except Exception as e:
            print(f"โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุชุงุจุฉ ุฅูู ููู ุงููุฎุฑุฌุงุช: {e}")

    print("\n" + "=" * 60)
    print("๐ ุงูุชููุช ุงูุนูููุฉ ุจูุฌุงุญ!")
    print("=" * 60)


if __name__ == "__main__":
    main()