# -*- coding: utf-8 -*-
import os
import re
from pathlib import Path

# ==============================================================================
# 1. ุงูุฅุนุฏุงุฏุงุช - ูู ุจุชุบููุฑ ูุฐู ุงููุณุงุฑุงุช ูุชูุงุณุจ ุฌูุงุฒู
# ==============================================================================

# ุงููุณุงุฑ ุงููุงูู ูููู txt ุงูุฐู ูุญุชูู ุนูู ุฑูุงุจุท ุชูู ุชูู
# ููุงุญุธุฉ: ุญุฑู 'r' ูุจู ุงููุต ูููุน ุจุงูุซูู ูู ุงูุชุนุงูู ูุน '\' ูุญุฑู ุฎุงุต
INPUT_FILE_PATH = r"C:\Users\Stark\Download\myhome\video_rating_app\Names\ids_to_dib.txt"

# ุงููุณุงุฑ ุงููุงูู ูููุฌูุฏ ุงูุฑุฆูุณู ุงูุฐู ูุญุชูู ุนูู ููุฏูููุงุชู ุงููุญููุฉ
VIDEOS_DIRECTORY_PATH = r"C:\Users\Stark\Download\myhome\video_rating_app\NS\TikTok"


# ==============================================================================
# 2. ุงูุฏูุงู ุงููุณุงุนุฏุฉ - ูุง ุชุญุชุงุฌ ูุชุนุฏูู ูุฐุง ุงูุฌุฒุก
# ==============================================================================

# START: MODIFIED SECTION
def extract_id_from_url(url: str) -> str | None:
    """
    ูุณุชุฎุฑุฌ ุฑูู ุงูู ID ูู ุฑุงุจุท ุชูู ุชูู.
    ุฃูุซูุฉ: 
    '.../video/7526880825388928274' -> '7526880825388928274'
    '.../hdplay/7554553515532668215.mp4' -> '7554553515532668215'
    """
    url = url.strip()
    if not url:
        return None
    
    try:
        # 1. ุฎุฐ ุงูุฌุฒุก ุงูุฃุฎูุฑ ูู ุงูุฑุงุจุท ุจุนุฏ ุขุฎุฑ ุนูุงูุฉ '/'
        last_part = url.split('/')[-1]
        
        # 2. ุงูุตู ูุฐุง ุงูุฌุฒุก ุนูุฏ ุฃูู ููุทุฉ '.' ูุฅุฒุงูุฉ ุงูุชุฏุงุฏ ุงูููู ูุซู .mp4
        #    ุณูุคุฏู ูุฐุง ุฅูู ุชุญููู '755...215.mp4' ุฅูู '755...215'
        #    ูุฅุฐุง ูู ููู ููุงู ููุทุฉุ ุณูุจูู ุงููุต ููุง ูู '752...274'
        video_id = last_part.split('.')[0]

        # 3. ุงูุชุญูู ูู ุฃู ุงูุฌุฒุก ุงููุชุจูู ูู ุฑูู ุจุงููุนู
        if video_id.isdigit():
            return video_id
    except IndexError:
        return None # ูู ุญุงู ูุงู ุงูุฑุงุจุท ูุงุฑุบุงู ุฃู ุบูุฑ ุตุงูุญ
    return None
# END: MODIFIED SECTION

def extract_id_from_filename(filename: str) -> str | None:
    """
    ูุณุชุฎุฑุฌ ุฑูู ุงูู ID ูู ุงุณู ููู ูุนูุฏ.
    ูุจุญุซ ุนู ุฃูู ุณูุณูุฉ ุฃุฑูุงู ูุชุชุงููุฉ ูุฒูุฏ ุทูููุง ุนู 10 ุฃุฑูุงู.
    """
    # ุงูุชุนุจูุฑ ุงูููุทู (Regex) ููุจุญุซ ุนู 11 ุฑูููุง ุฃู ุฃูุซุฑ ุนูู ุงูุชูุงูู
    # \d{11,}  ุชุนูู: ุงุจุญุซ ุนู ุฃู ุฑูู (\d) ููุฑุฑ 11 ูุฑุฉ ุฃู ุฃูุซุฑ ({11,})
    match = re.search(r'\d{11,}', filename)
    
    if match:
        # ุฅุฐุง ุชู ุงูุนุซูุฑ ุนูู ุชุทุงุจูุ ูู ุจุฅุฑุฌุงุน ุงูุณูุณูุฉ ุงูุฑูููุฉ ุงูุชู ุชู ุงูุนุซูุฑ ุนูููุง
        return match.group(0)
    
    return None # ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ุชุทุงุจู

# ==============================================================================
# 3. ุงูุณูุฑุจุช ุงูุฑุฆูุณู - ูููู ุจุชูููุฐ ุงูููุทู
# ==============================================================================

def main():
    """ุงููุธููุฉ ุงูุฑุฆูุณูุฉ ูุชุดุบูู ุงูุณูุฑุจุช"""
    print("=" * 60)
    print("๐ ุจุฏุก ุนูููุฉ ููุชุฑุฉ ุฑูุงุจุท ุชูู ุชูู ุงูููุฑุฑุฉ")
    print("=" * 60)

    # ุชุญููู ุงููุตูุต ุฅูู ูุงุฆูุงุช Path ููุชุนุงูู ูุน ุงููุณุงุฑุงุช ุจุดูู ุฃูุถู
    input_file = Path(INPUT_FILE_PATH)
    videos_dir = Path(VIDEOS_DIRECTORY_PATH)

    # --- ุงูุฎุทูุฉ 1: ุงูุชุญูู ูู ูุฌูุฏ ุงูููู ูุงููุฌูุฏ ---
    if not input_file.is_file():
        print(f"โ ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ููู ุงูุฑูุงุจุท ูู ุงููุณุงุฑ:\n{input_file}")
        return
    
    if not videos_dir.is_dir():
        print(f"โ ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ูุฌูุฏ ุงูููุฏูููุงุช ูู ุงููุณุงุฑ:\n{videos_dir}")
        return

    # --- ุงูุฎุทูุฉ 2: ูุฑุงุกุฉ ููู ุงูุฑูุงุจุท ูุงุณุชุฎุฑุงุฌ ุฃุฑูุงู ุงูู ID ---
    print(f"\n[1/4] ๐ ุฌุงุฑู ูุฑุงุกุฉ ุงูุฑูุงุจุท ูู ููู: {input_file.name}")
    url_data = {} # ุณูุณุชุฎุฏู ูุงููุณ ูุชุฎุฒูู ุงูุฑุงุจุท ูุน ุงูู ID ุงูุฎุงุต ุจู
    try:
        with open(input_file, 'r', encoding='utf-8') as f:
            for line in f:
                url = line.strip()
                if url:
                    video_id = extract_id_from_url(url)
                    if video_id:
                        url_data[video_id] = url
    except Exception as e:
        print(f"โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุฑุงุกุฉ ุงูููู: {e}")
        return

    print(f"โ๏ธ ุชู ุงูุนุซูุฑ ุนูู {len(url_data)} ุฑุงุจุท ุตุงูุญ.")

    # --- ุงูุฎุทูุฉ 3: ูุณุญ ูุฌูุฏ ุงูููุฏูููุงุช ูุงุณุชุฎุฑุงุฌ ุฃุฑูุงู ุงูู ID ุงูููุฌูุฏุฉ ---
    print(f"\n[2/4] ๐ ุฌุงุฑู ูุณุญ ูุฌูุฏ ุงูููุฏูููุงุช ูุฌููุน ุงููุฌูุฏุงุช ุงููุฑุนูุฉ...")
    
    # ูุณุชุฎุฏู Set ูุชุฎุฒูู ุฃุฑูุงู ุงูู ID ุงูููุฌูุฏุฉ ูุฃููุง ุฃุณุฑุน ูู ุงูุจุญุซ ูุชููุน ุงูุชูุฑุงุฑ
    existing_video_ids = set()
    total_files_scanned = 0

    # os.walk ูููู ุจุงููุฑูุฑ ุนูู ุงููุฌูุฏ ูุฌููุน ุงููุฌูุฏุงุช ุงููุฑุนูุฉ ุชููุงุฆูุงู
    for root, dirs, files in os.walk(videos_dir):
        for filename in files:
            total_files_scanned += 1
            video_id = extract_id_from_filename(filename)
            if video_id:
                existing_video_ids.add(video_id)
    
    print(f"โ๏ธ ุชู ูุณุญ {total_files_scanned} ููู ูุงูุนุซูุฑ ุนูู {len(existing_video_ids)} ููุฏูู ูุญูู ุจุงููุนู.")

    # --- ุงูุฎุทูุฉ 4: ุชุญุฏูุฏ ุงูุฑูุงุจุท ุงููุฑูุฏุฉ (ุงูุฌุฏูุฏุฉ) ---
    print("\n[3/4] ๐ ุฌุงุฑู ููุงุฑูุฉ ุงูููุงุฆู ูุชุญุฏูุฏ ุงูุฑูุงุจุท ุงูุฌุฏูุฏุฉ...")
    
    unique_urls_to_download = []
    for video_id, url in url_data.items():
        # ุฅุฐุง ูุงู ID ุงูููุฏูู ุบูุฑ ููุฌูุฏ ูู ูุฌููุนุฉ ุงูููุฏูููุงุช ุงููุญููุฉุ ููู ุฑุงุจุท ุฌุฏูุฏ
        if video_id not in existing_video_ids:
            unique_urls_to_download.append(url)

    total_urls = len(url_data)
    total_unique = len(unique_urls_to_download)
    total_duplicates = total_urls - total_unique
    
    print(f"โ๏ธ ุงูููุงุฑูุฉ ุงูุชูุช:")
    print(f"   - ุฅุฌูุงูู ุงูุฑูุงุจุท: {total_urls}")
    print(f"   - ุฑูุงุจุท ููุฑุฑุฉ (ููุฌูุฏุฉ): {total_duplicates}")
    print(f"   - ุฑูุงุจุท ูุฑูุฏุฉ (ุฌุฏูุฏุฉ): {total_unique}")

    # --- ุงูุฎุทูุฉ 5: ูุชุงุจุฉ ุงูุฑูุงุจุท ุงููุฑูุฏุฉ ูู ููู ุฌุฏูุฏ ---
    if not unique_urls_to_download:
        print("\n[4/4] โ ูุง ุชูุฌุฏ ุฑูุงุจุท ุฌุฏูุฏุฉ ูุชุญููููุง. ูู ุดูุก ูุญุฏุซ!")
    else:
        # ุชุญุฏูุฏ ุงุณู ููุณุงุฑ ุงูููู ุงูุฌุฏูุฏ ุจุฌูุงุฑ ุงูููู ุงูุฃุตูู
        output_file = input_file.with_name("unique_links_to_download.txt")
        print(f"\n[4/4] ๐พ ุฌุงุฑู ูุชุงุจุฉ ุงูุฑูุงุจุท ุงูุฌุฏูุฏุฉ ูู ููู: {output_file.name}")
        
        try:
            with open(output_file, 'w', encoding='utf-8') as f:
                for url in unique_urls_to_download:
                    f.write(url + "\n")
            print(f"โ๏ธ ุชู ุญูุธ {total_unique} ุฑุงุจุท ุฌุฏูุฏ ุจูุฌุงุญ ูู ุงููุณุงุฑ:\n{output_file}")
        except Exception as e:
            print(f"โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุชุงุจุฉ ุงูููู ุงูุฌุฏูุฏ: {e}")

    print("\n" + "=" * 60)
    print("๐ ุงูุชููุช ุงูุนูููุฉ ุจูุฌุงุญ!")
    print("=" * 60)


if __name__ == "__main__":
    main()