import cv2
import face_recognition
import os
import numpy as np

# --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: Ù‚Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… ---
# [Ù…Ù‡Ù…] Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­ØªÙ‡.
video_path = r"C:\Users\Stark\Download\myhome\video_rating_app\s.mp4" 

# [Ù…Ù‡Ù…] Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø°ÙŠ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØ± ÙÙŠÙ‡ Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.
output_folder = "final_frames_for_lora"   

# [Ù…Ù‡Ù…] Ø¹ØªØ¨Ø© Ø§Ù„Ø­Ø¯Ø©. Ø§Ø¨Ø¯Ø£ Ø¨Ù€ 100. Ø¥Ø°Ø§ Ù„Ù… ØªØ­ØµÙ„ Ø¹Ù„Ù‰ ØµÙˆØ± ÙƒØ§ÙÙŠØ©ØŒ Ø¬Ø±Ø¨ 80. Ø¥Ø°Ø§ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ØµÙˆØ± ÙƒØ«ÙŠØ±Ø© Ø¶Ø¨Ø§Ø¨ÙŠØ©ØŒ Ø¬Ø±Ø¨ 120.
sharpness_threshold = 100.0           

# [Ù…Ù‡Ù…] Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª Ø§Ù„ØªÙŠ Ø³ÙŠØªØ®Ø·Ø§Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø¬ÙŠØ¯Ø© (Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø©).
# Ù‚ÙŠÙ…Ø© 24 Ø£Ùˆ 30 (Ø­Ø³Ø¨ Ø¥Ø·Ø§Ø±Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠØ©) ØªØ¹Ù†ÙŠ Ø£Ù†Ù‡ Ø³ÙŠØªØ®Ø·Ù‰ Ø«Ø§Ù†ÙŠØ© ÙƒØ§Ù…Ù„Ø© ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§.
frame_skip = 24                       
# ----------------------------------------

# Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø­Ø¯Ø© Ø§Ù„ØµÙˆØ±Ø© (Ø§Ù„ØªØ¨Ø§ÙŠÙ† Ø§Ù„Ù„Ø§Ø¨Ù„Ø§Ø³ÙŠ)
def get_sharpness(image):
    if image is None:
        return 0
    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
    return cv2.Laplacian(gray, cv2.CV_64F).var()

# Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª
if not os.path.exists(output_folder):
    os.makedirs(output_folder)
    print(f"ğŸ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª: '{output_folder}'")

# ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
cap = cv2.VideoCapture(video_path)
if not cap.isOpened():
    print(f"âŒ Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ '{video_path}'. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³Ø§Ø± ØµØ­ÙŠØ­ ÙˆØ£Ù† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯.")
    exit()

frame_count = 0
saved_count = 0
skip_counter = 0

print("ğŸš€ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø°ÙƒÙŠ... Ø³ÙŠØªÙ… ÙØ­Øµ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¢Ù†.")

while True:
    ret, frame = cap.read()
    if not ret:
        break # Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ

    frame_count += 1
    
    # ØªØ®Ø·ÙŠ Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØªØ¬Ù†Ø¨ Ø§Ù„ØªØ´Ø§Ø¨Ù‡
    if skip_counter > 0:
        skip_counter -= 1
        continue
    
    # [ØªØ­Ø³ÙŠÙ†] ØªØµØºÙŠØ± Ø§Ù„Ø¥Ø·Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ¬ÙˆÙ‡ Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø´ÙƒÙ„ Ù‡Ø§Ø¦Ù„
    small_frame = cv2.resize(frame, (0, 0), fx=0.5, fy=0.5)
    rgb_small_frame = cv2.cvtColor(small_frame, cv2.COLOR_BGR2RGB)
    
    # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ¬ÙˆÙ‡ ÙÙŠ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ù…ØµØºØ±
    face_locations = face_recognition.face_locations(rgb_small_frame)

    # Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ¬Ù‡ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
    if face_locations:
        # Ø­Ø³Ø§Ø¨ Ø­Ø¯Ø© Ø§Ù„ØµÙˆØ±Ø© (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø£ØµÙ„ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„ Ø§Ù„Ø¬ÙˆØ¯Ø©)
        sharpness = get_sharpness(frame)
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙˆØ±Ø© Ø­Ø§Ø¯Ø© Ø¨Ù…Ø§ ÙÙŠÙ‡ Ø§Ù„ÙƒÙØ§ÙŠØ©
        if sharpness > sharpness_threshold:
            saved_count += 1
            filename = os.path.join(output_folder, f"frame_{saved_count:04d}.png")
            cv2.imwrite(filename, frame)
            print(f"âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø·Ø§Ø± {saved_count} (Ø§Ù„Ø­Ø¯Ø©: {sharpness:.2f})")
            
            # ØªÙØ¹ÙŠÙ„ Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ®Ø·ÙŠ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù„Ù‚Ø·Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
            skip_counter = frame_skip
    
    # Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø¯Ù… ÙƒÙ„ 30 Ø¥Ø·Ø§Ø± (ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§)
    if frame_count % 30 == 0:
        print(f"â³ ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© {frame_count} Ø¥Ø·Ø§Ø±Ù‹Ø§...")


cap.release()
print(f"\nğŸ‰ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©! ØªÙ… Ø­ÙØ¸ {saved_count} ØµÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø© ÙÙŠ Ù…Ø¬Ù„Ø¯ '{output_folder}'.")