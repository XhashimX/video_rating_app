<!doctype html>
<html lang="ar">
  <head>
    <meta charset="utf-8" />
    <title>بدء مسابقة</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Cairo", sans-serif;
        background-color: #121212;
        color: #e0e0e0;
      }

      .container {
        max-width: 960px;
        margin: auto;
        background-color: #1e1e1e;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
      }

      h1 {
        color: #20c997;
        margin-bottom: 1rem;
        font-size: 2.5rem;
        text-align: center;
      }

      .form-label {
        color: #e0e0e0;
      }

      .form-control,
      .form-select {
        background-color: #343a40;
        color: #fff;
        border-color: #495057;
      }
      .form-control:focus,
      .form-select:focus {
        border-color: #20c997;
        box-shadow: 0 0 0 0.25rem rgba(32, 201, 151, 0.25);
      }

      .form-text {
        color: #adb5bd;
      }

      #competition-count {
        color: #FFC107;
        font-size: 1.2em;
        font-weight: bold;
      }

      .btn {
        padding: 0.3rem 0.6rem;
        margin: 4px;
        border-radius: 5px;
        transition:
          background-color 0.3s ease,
          border-color 0.3s ease;
        text-decoration: none;
        font-size: 0.9rem;
      }
      .btn:hover,
      .btn:focus {
        opacity: 0.9;
      }

      .btn-success {
        background-color: #198754;
        border-color: #198754;
        color: white;
      }

      .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
      }
      
      .btn-warning {
        color: #000;
        background-color: #ffc107;
        border-color: #ffc107;
      }
      
      .btn-danger {
        color: #fff;
        background-color: #dc3545;
        border-color: #dc3545;
      }
      
      .btn-info {
        color: #000;
        background-color: #0dcaf0;
        border-color: #0dcaf0;
      }

      .alert {
        border-radius: 4px;
        margin-bottom: 15px;
        color: #000;
      }

      textarea.form-control {
        min-height: 150px;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="text-center mb-4">
        <i class="fas fa-gamepad"></i> اختيار وضع المسابقة
      </h1>

      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %}
      <div class="mb-4">
        {% for category, message in messages %}
        <div
          class="alert alert-{{ category }} alert-dismissible fade show"
          role="alert"
        >
          <i class="fas fa-exclamation-triangle"></i>
          {{ message }}
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
            aria-label="Close"
          ></button>
        </div>
        {% endfor %}
      </div>
      {% endif %} {% endwith %}
      <form method="post" action="{{ url_for('competition') }}">

        <div class="mb-3">
            <label for="tournament_file" class="form-label">اختر ملف بطولة:</label>
            <div class="input-group">
                <select class="form-select" id="tournament_file" name="tournament_file">
                    <option value="">-- اختر ملف بطولة --</option>
                    {% for file in tournament_files %}
                    <option value="{{ file }}" {% if file == last_selected_file %}selected{% endif %}>{{ file }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="btn btn-warning" id="filter-unplayed-btn" style="display: none;" title="متابعة المباريات غير المكتملة">
                    <i class="fas fa-filter"></i> متابعة
                </button>
                <button type="button" class="btn btn-info" id="regroup-btn" style="display: none;" title="إعادة تجميع المتنافسين">
                    <i class="fas fa-random"></i> تجميع
                </button>
                <button type="button" class="btn btn-danger" id="delete-tournament-btn" style="display: none;" title="حذف الملف نهائياً">
                    <i class="fas fa-trash"></i> حذف
                </button>
                
                <button type="button" class="btn btn-secondary" id="rename-file-btn" style="display: none;" title="إعادة تسمية الملف الفعلي فقط">
                    <i class="fas fa-file-signature"></i> اسم الملف
                </button>
                <button type="button" class="btn btn-primary" id="rename-archive-btn" style="display: none;" title="إعادة تسمية السجل في الأرشيف فقط">
                    <i class="fas fa-book"></i> اسم الأرشيف
                </button>
                 <button type="button" class="btn btn-success" id="create-archive-btn" style="display: none;" title="إنشاء سجل جديد في الأرشيف لهذا الملف">
                    <i class="fas fa-plus-square"></i> + أرشيف
                </button>
            </div>
            <span id="competition-count" class="form-text text-muted"></span>
        </div>

        <div class="mb-3">
          <label for="json_data" class="form-label"
            >بيانات JSON للمنافسات:</label
          >
          <textarea
            class="form-control"
            id="json_data"
            name="json_data"
            rows="5"
            placeholder="أدخل بيانات المنافسة هنا بتنسيق JSON"
          ></textarea>
          <small class="form-text text-muted">
            مثال: [{"videos": ["video1", "video2"], "mode": 1, "num_videos": 2},
            {"videos": ["video3", "video4"], "mode": 3, "value": 1200,
            "num_videos": 2}]
          </small>
        </div>

        <div class="mb-3">
          <label for="mode" class="form-label">اختر وضع المسابقة:</label>
          <select class="form-select" id="mode" name="mode" required>
            <option value="1">عشوائية</option>
            <option value="2">أفضل النسبة المئوية</option>
            <option value="3">ملفات بتقييم أقل من قيمة معينة</option>
            <option value="4">ملفات بتقييم أعلى من قيمة معينة</option>
            <option value="5">ملفات بين قيمتين</option>
            <option value="6">ملفات خارج قيمتين</option>
            <option value="8">ملفات بين نطاقين منفصلين</option>
            <option value="7">عشوائي ثم الأقرب تقييم</option>
            <option value="9">ملفات بعدد مرات ظهور (نطاق)</option>
            <option value="10">ملفات بوسوم (Tags) معينة</option>
          </select>
        </div>


        <div class="mb-3" id="valueInput" style="display: none">
          <label for="value" class="form-label">أدخل القيمة:</label>
          <input
            type="number"
            class="form-control"
            id="value"
            name="value"
            placeholder="مثال: 1500"
          />
        </div>


        <div class="mb-3" id="min-max-input" style="display: none">
          <label for="min_value" class="form-label">القيمة الدنيا:</label>
          <input
            type="number"
            class="form-control"
            id="min_value"
            name="min_value"
            value="0"
          />
          <label for="max_value" class="form-label">القيمة القصوى:</label>
          <input
            type="number"
            class="form-control"
            id="max_value"
            name="max_value"
            value="1000"
          />
        </div>


        <div class="mb-3" id="range-inputs" style="display: none">
          <div class="mb-2">
            <label class="form-label">النطاق الأول:</label>
            <div class="row">
              <div class="col-md-6">
                <input
                  type="number"
                  class="form-control"
                  id="min_value1"
                  name="min_value1"
                  placeholder="الحد الأدنى"
                />
              </div>
              <div class="col-md-6">
                <input
                  type="number"
                  class="form-control"
                  id="max_value1"
                  name="max_value1"
                  placeholder="الحد الأعلى"
                />
              </div>
            </div>
          </div>
          <div>
            <label class="form-label">النطاق الثاني:</label>
            <div class="row">
              <div class="col-md-6">
                <input
                  type="number"
                  class="form-control"
                  id="min_value2"
                  name="min_value2"
                  placeholder="الحد الأدنى"
                />
              </div>
              <div class="col-md-6">
                <input
                  type="number"
                  class="form-control"
                  id="max_value2"
                  name="max_value2"
                  placeholder="الحد الأعلى"
                />
              </div>
            </div>
          </div>
        </div>

        <div class="mb-3" id="times-shown-input" style="display: none">
          <label for="min_times_shown" class="form-label">الحد الأدنى لمرات الظهور:</label>
          <input
            type="number"
            class="form-control"
            id="min_times_shown"
            name="min_times_shown"
            value="0"
          />
          <label for="max_times_shown" class="form-label">الحد الأقصى لمرات الظهور:</label>
          <input
            type="number"
            class="form-control"
            id="max_times_shown"
            name="max_times_shown"
            value="10"
          />
        </div>

        <div class="mb-3" id="tags-mode-input" style="display: none">
          <label for="tags_value_mode_input" class="form-label">أدخل الوسوم (مفصولة بفاصلة):</label>
          <input
            type="text"
            class="form-control"
            id="tags_value_mode_input"
            name="tags_value_mode_input"
            placeholder="مثال: tag1,tag2,Top"
          />
        </div>

        <div class="mb-3">
          <label for="num_videos" class="form-label"
            >عدد الملفات في المسابقة:</label
          >
          <input
            type="number"
            class="form-control"
            id="num_videos"
            name="num_videos"
            min="2"
            value="2"
            required
          />
        </div>
        <div class="mb-3">
          <label for="ranking_type" class="form-label">نوع الترتيب:</label>
          <select
            class="form-select"
            id="ranking_type"
            name="ranking_type"
            required
          >
            <option value="" disabled selected>اختر نوع الترتيب</option>
            <option value="rank">ترتيب</option>
            <option value="winner_only" selected>فائز واحد فقط</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="use_dynamic_weighting" class="form-label"
            >طريقة اختيار الفيديوهات:</label
          >
          <select
            class="form-select"
            id="use_dynamic_weighting"
            name="use_dynamic_weighting"
            required
          >
            <option value="false">عشوائي</option>
            <option value="true" selected>ترجيح ديناميكي</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="competition_type" class="form-label"
            >نظام المنافسة:</label
          >
          <select
            class="form-select"
            id="competition_type"
            name="competition_type"
            required
          >
            <option value="random" selected>عشوائي</option>
            <option value="ring">حلبة</option>
          </select>
        </div>
        <button type="submit" class="btn btn-success">
          <i class="fas fa-play"></i> بدء المسابقة
        </button>

        <a href="{{ url_for('index') }}" class="btn btn-secondary"
          ><i class="fas fa-arrow-left"></i> العودة إلى الصفحة الرئيسية</a
        >

      </form>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const modeSelect = document.getElementById("mode");
    const valueInput = document.getElementById("valueInput");
    const minMaxInput = document.getElementById("min-max-input");
    const rangeInputs = document.getElementById("range-inputs");
    const timesShownInput = document.getElementById("times-shown-input");
    const tagsModeInput = document.getElementById("tags-mode-input");
    const tournamentFileSelect = document.getElementById("tournament_file");
    const jsonDataTextarea = document.getElementById("json_data");
    const competitionCountSpan = document.getElementById("competition-count");

    const filterBtn = document.getElementById("filter-unplayed-btn");
    const deleteBtn = document.getElementById("delete-tournament-btn");
    const regroupBtn = document.getElementById("regroup-btn");

    // تعريف الأزرار الجديدة
    const renameFileBtn = document.getElementById("rename-file-btn");
    const renameArchiveBtn = document.getElementById("rename-archive-btn");
    const createArchiveBtn = document.getElementById("create-archive-btn");

    function updateFileContent(selectedFile) {
      if (selectedFile) {
        // إظهار الأزرار عند اختيار ملف
        filterBtn.style.display = "inline-block";
        deleteBtn.style.display = "inline-block";
        regroupBtn.style.display = "inline-block";
        renameFileBtn.style.display = "inline-block";
        renameArchiveBtn.style.display = "inline-block";
        createArchiveBtn.style.display = "inline-block";

        fetch("/get_tournament_content/" + encodeURIComponent(selectedFile))
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.raw_content) {
              try {
                const parsedJson = JSON.parse(data.raw_content);
                document.getElementById("json_data").value = JSON.stringify(
                  parsedJson,
                  null,
                  4
                );
                if (Array.isArray(parsedJson)) {
                  document.getElementById(
                    "competition-count"
                  ).textContent = `إجمالي المسابقات: ${parsedJson.length}`;
                } else {
                  competitionCountSpan.textContent =
                    "المحتوى ليس قائمة مسابقات.";
                }
              } catch (e) {
                document.getElementById("json_data").value = data.raw_content;
                competitionCountSpan.textContent = "المحتوى ليس بصيغة JSON.";
              }
            } else {
              jsonDataTextarea.value = `فشل تحميل المحتوى: ${
                data.message || "خطأ غير معروف"
              }`;
              competitionCountSpan.textContent = "";
            }
          })
          .catch((error) => {
            console.error("Error fetching file content:", error);
            jsonDataTextarea.value = `خطأ في الشبكة: ${error.message}`;
            competitionCountSpan.textContent = "";
          });
      } else {
        // إخفاء الأزرار
        filterBtn.style.display = "none";
        deleteBtn.style.display = "none";
        regroupBtn.style.display = "none";
        renameFileBtn.style.display = "none";
        renameArchiveBtn.style.display = "none";
        createArchiveBtn.style.display = "none";

        document.getElementById("json_data").value = "";
        document.getElementById("competition-count").textContent = "";
      }
    }

    tournamentFileSelect.addEventListener("change", function () {
      updateFileContent(this.value);
    });

    if (tournamentFileSelect.value) {
      updateFileContent(tournamentFileSelect.value);
    }

    // --- زر الفلترة (تم حذف الـ alerts) ---
    filterBtn.addEventListener("click", function () {
      const selectedFile = tournamentFileSelect.value;
      if (!selectedFile) return; // Silent return

      this.disabled = true;
      this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جار الفلترة...';

      fetch("/filter_unplayed/" + encodeURIComponent(selectedFile))
        .then((response) => {
          if (!response.ok) {
            return response.json().then((err) => {
              throw new Error(err.error || err.message || "حدث خطأ.");
            });
          }
          return response.json();
        })
        .then((result) => {
          if (result.error) {
            throw new Error(result.error);
          }

          if (result.status === "completed") {
            updateFileContent(selectedFile);
          } else if (result.status === "completion_failed") {
            throw new Error(result.message);
          } else if (typeof result.data !== "undefined") {
            const filteredData = result.data;
            jsonDataTextarea.value = JSON.stringify(filteredData, null, 4);
            competitionCountSpan.textContent = `المسابقات المتبقية: ${filteredData.length}`;
          }
        })
        .catch((error) => {
          console.error("خطأ أثناء الفلترة:", error);
        })
        .finally(() => {
          this.disabled = false;
          this.innerHTML = '<i class="fas fa-filter"></i> متابعة';
        });
    });

    // --- زر الحذف (تم حذف confirm و alert النجاح) ---
    deleteBtn.addEventListener("click", function () {
      const selectedFile = tournamentFileSelect.value;
      if (!selectedFile) return;

      this.disabled = true;
      fetch("/api/manage_tournament_file", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "delete", filename: selectedFile }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            location.reload();
          } else {
            alert("فشل الحذف: " + data.message); // نبقي رسالة الخطأ فقط
            this.disabled = false;
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          this.disabled = false;
        });
    });

    // --- زر إعادة التجميع (تم حذف confirm و alert النجاح) ---
    regroupBtn.addEventListener("click", function () {
      const selectedFile = tournamentFileSelect.value;
      if (!selectedFile) return;

      const newSizeStr = prompt(
        "أدخل العدد الجديد للفيديوهات في كل مسابقة (2 أو أكثر):",
        "2"
      );
      if (newSizeStr === null) return;

      const newSize = parseInt(newSizeStr, 10);
      if (isNaN(newSize) || newSize < 2) return; // Silent return on invalid input

      this.disabled = true;

      fetch("/regroup_competitions", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          filename: selectedFile,
          new_num_videos: newSize,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            updateFileContent(selectedFile);
          } else {
            alert("فشل إعادة التجميع: " + data.message); // نبقي رسالة الخطأ
          }
        })
        .catch((error) => {
          console.error("Error:", error);
        })
        .finally(() => {
          this.disabled = false;
        });
    });

    // --- 1. زر إعادة تسمية الملف (تم حذف confirm و alert النجاح) ---
    renameFileBtn.addEventListener("click", function () {
      const selectedFile = tournamentFileSelect.value;
      if (!selectedFile) return;

      const newName = prompt(
        "أدخل الاسم الجديد للملف (بدون .json):",
        selectedFile.replace(".json", "")
      );
      if (
        newName &&
        newName.trim() !== "" &&
        newName + ".json" !== selectedFile
      ) {

        fetch("/rename_tournament_file_action", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            old_filename: selectedFile,
            new_filename: newName + ".json",
          }),
        })
          .then((r) => r.json())
          .then((data) => {
            if (data.success) location.reload();
          })
          .catch((error) => {
            console.error("Error renaming file:", error);
          });
      }
    });

    // --- 2. زر إعادة تسمية الأرشيف (تم حذف confirm و alert النجاح) ---
    renameArchiveBtn.addEventListener("click", function () {
      const selectedFile = tournamentFileSelect.value;
      if (!selectedFile) return;

      const currentKey = selectedFile.replace(".json", "");

      const newName = prompt("أدخل الاسم الجديد لسجل الأرشيف:", currentKey);
      if (newName && newName.trim() !== "" && newName !== currentKey) {

        fetch("/rename_archive_entry_action", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            filename: selectedFile,
            new_name: newName.trim(),
          }),
        })
          .then((r) => r.json())
          .then((data) => {
            // لا نحتاج لأي شيء آخر، العملية تمت في الخلفية
          })
          .catch((error) => {
            console.error("Error renaming archive entry:", error);
          });
      }
    });

    // --- 3. زر إنشاء سجل أرشيف (تم حذف confirm و alert النجاح) ---
    createArchiveBtn.addEventListener("click", function () {
      const selectedFile = tournamentFileSelect.value;
      if (!selectedFile) return;

      const participantsStr = prompt("أدخل عدد المشاركين الأولي:", "32");
      if (participantsStr === null) return;

      const participants = parseInt(participantsStr, 10);
      if (isNaN(participants) || participants <= 0) return;

      fetch("/create_archive_entry_action", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          filename: selectedFile,
          participants: participants,
        }),
      })
        .then((r) => r.json())
        .then((data) => {
        })
        .catch((error) => {
          console.error("Error creating archive entry:", error);
        });
    });

    modeSelect.addEventListener("change", function () {
      valueInput.style.display = "none";
      minMaxInput.style.display = "none";
      rangeInputs.style.display = "none";
      timesShownInput.style.display = "none";
      tagsModeInput.style.display = "none";
      const allValueInputs = document.querySelectorAll(
        "#valueInput input, #min-max-input input, #range-inputs input, #times-shown-input input, #tags-mode-input input"
      );
      allValueInputs.forEach((input) => {
        input.required = false;
      });
      if (this.value === "3" || this.value === "4") {
        valueInput.style.display = "block";
        document.getElementById("value").required = true;
      } else if (this.value === "5" || this.value === "6") {
        minMaxInput.style.display = "block";
        document.getElementById("min_value").required = true;
        document.getElementById("max_value").required = true;
      } else if (this.value === "8") {
        rangeInputs.style.display = "block";
        document.getElementById("min_value1").required = true;
        document.getElementById("max_value1").required = true;
        document.getElementById("min_value2").required = true;
        document.getElementById("max_value2").required = true;
      } else if (this.value === "9") {
        timesShownInput.style.display = "block";
        document.getElementById("min_times_shown").required = true;
        document.getElementById("max_times_shown").required = true;
      } else if (this.value === "10") {
        tagsModeInput.style.display = "block";
        document.getElementById("tags_value_mode_input").required = true;
      }
    });
    modeSelect.dispatchEvent(new Event("change"));

    <!-- START: MODIFIED SECTION - Keyboard Shortcuts for Competition Page -->
    document.addEventListener('keydown', function(event) {
        // منع الاختصارات إذا كان المستخدم يكتب في حقل نصي أو يختار من قائمة
        if (['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) {
            return;
        }

        // منع الاختصارات إذا كانت نافذة prompt أو alert مفتوحة
        // (هذا ليس مثالياً ولكنه يمنع بعض التضاربات)
        if(document.body.classList.contains('modal-open')) return;

        const key = event.key.toLowerCase();

        // استخدام switch لتنظيم الكود
        switch (key) {
            case 'c': // متابعة
                event.preventDefault();
                const filterBtn = document.getElementById('filter-unplayed-btn');
                if (filterBtn && filterBtn.style.display !== 'none') {
                    filterBtn.click();
                }
                break;
            
            case 's': // بدء المسابقة
                event.preventDefault();
                const startBtn = document.querySelector('form button.btn-success[type="submit"]');
                if (startBtn) {
                    startBtn.click();
                }
                break;

            case 'a': // تجميع
                event.preventDefault();
                const regroupBtn = document.getElementById('regroup-btn');
                if (regroupBtn && regroupBtn.style.display !== 'none') {
                    regroupBtn.click();
                }
                break;
            
            case 'd': // حذف
                event.preventDefault();
                const deleteBtn = document.getElementById('delete-tournament-btn');
                if (deleteBtn && deleteBtn.style.display !== 'none') {
                    deleteBtn.click();
                }
                break;

            case 'h': // العودة للرئيسية
                event.preventDefault();
                const homeBtn = document.querySelector('a.btn-secondary');
                if (homeBtn) {
                    homeBtn.click();
                }
                break;

            case 'r': // إعادة تسمية الملف
                event.preventDefault();
                const renameFileBtn = document.getElementById('rename-file-btn');
                if (renameFileBtn && renameFileBtn.style.display !== 'none') {
                    renameFileBtn.click();
                }
                break;
            
            case 't': // إعادة تسمية الأرشيف
                event.preventDefault();
                const renameArchiveBtn = document.getElementById('rename-archive-btn');
                if (renameArchiveBtn && renameArchiveBtn.style.display !== 'none') {
                    renameArchiveBtn.click();
                }
                break;
        }
    });
    <!-- END: MODIFIED SECTION -->

  });
</script>
  </body>
</html>