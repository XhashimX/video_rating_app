<!-- START OF FILE templates/start_competition.html -->
<!doctype html>
<html lang="ar">
  <head>
    <meta charset="utf-8" />
    <title>بدء مسابقة</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Cairo", sans-serif;
        background-color: #121212;
        color: #e0e0e0;
      }

      .container {
        max-width: 960px;
        margin: auto;
        background-color: #1e1e1e;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
      }

      h1 {
        color: #20c997;
        margin-bottom: 1rem;
        font-size: 2.5rem;
        text-align: center;
      }

      .form-label {
        color: #e0e0e0;
      }

      .form-control,
      .form-select {
        background-color: #343a40;
        color: #fff;
        border-color: #495057;
      }
      .form-control:focus,
      .form-select:focus {
        border-color: #20c997;
        box-shadow: 0 0 0 0.25rem rgba(32, 201, 151, 0.25);
      }

      .form-text {
        color: #adb5bd;
      }

      #competition-count {
        color: #FFC107;
        font-size: 1.2em;
        font-weight: bold;
      }

      .btn {
        padding: 0.3rem 0.6rem;
        margin: 4px;
        border-radius: 5px;
        transition:
          background-color 0.3s ease,
          border-color 0.3s ease;
        text-decoration: none;
        font-size: 0.9rem;
      }
      .btn:hover,
      .btn:focus {
        opacity: 0.9;
      }

      /* تنسيق لتمييز حرف الاختصار داخل الزر */
      .shortcut-key {
          font-weight: bold;
          background-color: rgba(0,0,0,0.2);
          padding: 0 5px;
          border-radius: 3px;
          margin-left: 5px;
          font-family: monospace;
          font-size: 1.1em;
      }
      
      /* تنسيق خاص لاختصار القائمة */
      .label-shortcut {
          color: #FFC107;
          font-family: monospace;
          background-color: #333;
          padding: 2px 6px;
          border-radius: 4px;
          margin-right: 5px;
          font-size: 0.9em;
      }

      .btn-success {
        background-color: #198754;
        border-color: #198754;
        color: white;
      }
      
      .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
      }

      .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
      }
      
      .btn-warning {
        color: #000;
        background-color: #ffc107;
        border-color: #ffc107;
      }
      
      .btn-danger {
        color: #fff;
        background-color: #dc3545;
        border-color: #dc3545;
      }
      
      .btn-info {
        color: #000;
        background-color: #0dcaf0;
        border-color: #0dcaf0;
      }

      .alert {
        border-radius: 4px;
        margin-bottom: 15px;
        color: #000;
      }

      textarea.form-control {
        min-height: 150px;
      }

      /* تنسيق إضافي لعرض الاسم الكامل */
      #selected-file-full-name {
          color: #64ffda; /* لون مميز (أخضر فاتح) */
          background-color: #212529;
          padding: 8px;
          border-radius: 4px;
          margin-top: 5px;
          font-family: monospace;
          word-break: break-all; /* كسر الكلمات الطويلة */
          display: none; /* مخفي افتراضياً */
          border: 1px solid #495057;
      }

      /* Modal Styling copied from Manage Tournaments */
      .modal-content {
        background-color: #161b22;
        color: #c9d1d9;
        border: 1px solid #30363d;
      }
      .modal-header { border-bottom: 1px solid #30363d; }
      .modal-footer { border-top: 1px solid #30363d; }
      .competitor-item, .competition-select-item {
        background-color: #21262d;
        border: 1px solid #30363d;
        padding: 8px 12px;
        margin-bottom: 6px;
        border-radius: 6px;
        cursor: pointer;
      }
      .competition-select-item.selected {
          background-color: #1f6feb;
          color: white;
          border-color: #1f6feb;
      }
      .competitor-item:hover, .competition-select-item:hover {
        border-color: #58a6ff;
      }
      .step-hidden { display: none; }

    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="text-center mb-4">
        <i class="fas fa-gamepad"></i> اختيار وضع المسابقة
      </h1>

      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %}
      <div class="mb-4">
        {% for category, message in messages %}
        <div
          class="alert alert-{{ category }} alert-dismissible fade show"
          role="alert"
        >
          <i class="fas fa-exclamation-triangle"></i>
          {{ message }}
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
            aria-label="Close"
          ></button>
        </div>
        {% endfor %}
      </div>
      {% endif %} {% endwith %}
      <form method="post" action="{{ url_for('competition') }}">

        <div class="mb-3">
            <label for="tournament_file" class="form-label">
                اختر ملف بطولة: <span class="label-shortcut">[`]</span> <span class="label-shortcut">[1/2 للتنقل]</span>
            </label>
            <div class="input-group">
                <select class="form-select" id="tournament_file" name="tournament_file">
                    <option value="">-- اختر ملف بطولة --</option>
                    {% for file in tournament_files %}
                    <option value="{{ file }}" {% if file == last_selected_file %}selected{% endif %}>{{ file }}</option>
                    {% endfor %}
                </select>
                <!-- START: BUTTONS -->
                <button type="button" class="btn btn-warning" id="filter-unplayed-btn" style="display: none;" title="متابعة المباريات غير المكتملة">
                    <i class="fas fa-filter"></i> <span class="shortcut-key">[C]</span> متابعة
                </button>
                <button type="button" class="btn btn-info" id="regroup-btn" style="display: none;" title="إعادة تجميع المتنافسين">
                    <i class="fas fa-random"></i> <span class="shortcut-key">[A]</span> تجميع
                </button>
                <button type="button" class="btn btn-danger" id="delete-tournament-btn" style="display: none;" title="حذف الملف نهائياً">
                    <i class="fas fa-trash"></i> <span class="shortcut-key">[D]</span> حذف
                </button>
                
                <button type="button" class="btn btn-secondary" id="rename-file-btn" style="display: none;" title="إعادة تسمية الملف الفعلي فقط">
                    <i class="fas fa-file-signature"></i> اسم الملف
                </button>
                <button type="button" class="btn btn-primary" id="rename-archive-btn" style="display: none;" title="إعادة تسمية السجل في الأرشيف فقط">
                    <i class="fas fa-book"></i> <span class="shortcut-key">[R]</span> اسم الأرشيف
                </button>
                 <button type="button" class="btn btn-success" id="create-archive-btn" style="display: none;" title="إنشاء سجل جديد في الأرشيف لهذا الملف">
                    <i class="fas fa-plus-square"></i> + أرشيف
                </button>
                <!-- الزر المخفي لفتح مودال التبديل -->
                <button type="button" id="open-swap-modal-btn" style="display: none;"></button>
                <!-- END: BUTTONS -->
            </div>
            
            <!-- START: MODIFIED SECTION - مكان عرض الاسم الكامل -->
            <div id="selected-file-full-name"></div>
            <!-- END: MODIFIED SECTION -->

            <span id="competition-count" class="form-text text-muted"></span>
        </div>

        <div class="mb-3">
          <label for="json_data" class="form-label"
            >بيانات JSON للمنافسات (Q للتبديل السريع):</label
          >
          <textarea
            class="form-control"
            id="json_data"
            name="json_data"
            rows="5"
            placeholder="أدخل بيانات المنافسة هنا بتنسيق JSON"
          ></textarea>
          <small class="form-text text-muted">
            مثال: [{"videos": ["video1", "video2"], "mode": 1, "num_videos": 2},
            {"videos": ["video3", "video4"], "mode": 3, "value": 1200,
            "num_videos": 2}]
          </small>
        </div>

        <div class="mb-3">
          <label for="mode" class="form-label">اختر وضع المسابقة:</label>
          <select class="form-select" id="mode" name="mode" required>
            <option value="1">عشوائية</option>
            <option value="2">أفضل النسبة المئوية</option>
            <option value="3">ملفات بتقييم أقل من قيمة معينة</option>
            <option value="4">ملفات بتقييم أعلى من قيمة معينة</option>
            <option value="5">ملفات بين قيمتين</option>
            <option value="6">ملفات خارج قيمتين</option>
            <option value="8">ملفات بين نطاقين منفصلين</option>
            <option value="7">عشوائي ثم الأقرب تقييم</option>
            <option value="9">ملفات بعدد مرات ظهور (نطاق)</option>
            <option value="10">ملفات بوسوم (Tags) معينة</option>
          </select>
        </div>


        <div class="mb-3" id="valueInput" style="display: none">
          <label for="value" class="form-label">أدخل القيمة:</label>
          <input
            type="number"
            class="form-control"
            id="value"
            name="value"
            placeholder="مثال: 1500"
          />
        </div>


        <div class="mb-3" id="min-max-input" style="display: none">
          <label for="min_value" class="form-label">القيمة الدنيا:</label>
          <input
            type="number"
            class="form-control"
            id="min_value"
            name="min_value"
            value="0"
          />
          <label for="max_value" class="form-label">القيمة القصوى:</label>
          <input
            type="number"
            class="form-control"
            id="max_value"
            name="max_value"
            value="1000"
          />
        </div>


        <div class="mb-3" id="range-inputs" style="display: none">
          <div class="mb-2">
            <label class="form-label">النطاق الأول:</label>
            <div class="row">
              <div class="col-md-6">
                <input
                  type="number"
                  class="form-control"
                  id="min_value1"
                  name="min_value1"
                  placeholder="الحد الأدنى"
                />
              </div>
              <div class="col-md-6">
                <input
                  type="number"
                  class="form-control"
                  id="max_value1"
                  name="max_value1"
                  placeholder="الحد الأعلى"
                />
              </div>
            </div>
          </div>
          <div>
            <label class="form-label">النطاق الثاني:</label>
            <div class="row">
              <div class="col-md-6">
                <input
                  type="number"
                  class="form-control"
                  id="min_value2"
                  name="min_value2"
                  placeholder="الحد الأدنى"
                />
              </div>
              <div class="col-md-6">
                <input
                  type="number"
                  class="form-control"
                  id="max_value2"
                  name="max_value2"
                  placeholder="الحد الأعلى"
                />
              </div>
            </div>
          </div>
        </div>

        <div class="mb-3" id="times-shown-input" style="display: none">
          <label for="min_times_shown" class="form-label">الحد الأدنى لمرات الظهور:</label>
          <input
            type="number"
            class="form-control"
            id="min_times_shown"
            name="min_times_shown"
            value="0"
          />
          <label for="max_times_shown" class="form-label">الحد الأقصى لمرات الظهور:</label>
          <input
            type="number"
            class="form-control"
            id="max_times_shown"
            name="max_times_shown"
            value="10"
          />
        </div>

        <div class="mb-3" id="tags-mode-input" style="display: none">
          <label for="tags_value_mode_input" class="form-label">أدخل الوسوم (مفصولة بفاصلة):</label>
          <input
            type="text"
            class="form-control"
            id="tags_value_mode_input"
            name="tags_value_mode_input"
            placeholder="مثال: tag1,tag2,Top"
          />
        </div>

        <div class="mb-3">
          <label for="num_videos" class="form-label"
            >عدد الملفات في المسابقة:</label
          >
          <input
            type="number"
            class="form-control"
            id="num_videos"
            name="num_videos"
            min="2"
            value="2"
            required
          />
        </div>
        <div class="mb-3">
          <label for="ranking_type" class="form-label">نوع الترتيب:</label>
          <select
            class="form-select"
            id="ranking_type"
            name="ranking_type"
            required
          >
            <option value="" disabled selected>اختر نوع الترتيب</option>
            <option value="rank">ترتيب</option>
            <option value="winner_only" selected>فائز واحد فقط</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="use_dynamic_weighting" class="form-label"
            >طريقة اختيار الفيديوهات:</label
          >
          <select
            class="form-select"
            id="use_dynamic_weighting"
            name="use_dynamic_weighting"
            required
          >
            <option value="false">عشوائي</option>
            <option value="true" selected>ترجيح ديناميكي</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="competition_type" class="form-label"
            >نظام المنافسة:</label
          >
          <select
            class="form-select"
            id="competition_type"
            name="competition_type"
            required
          >
            <option value="random" selected>عشوائي</option>
            <option value="ring">حلبة</option>
          </select>
        </div>
        
        <!-- START: MODIFIED BUTTONS GROUP -->
        <button type="submit" id="btn-start" class="btn btn-success">
          <i class="fas fa-play"></i> <span class="shortcut-key">[S]</span> بدء المسابقة
        </button>

        <a href="{{ url_for('tour_page') }}" id="btn-tour" class="btn btn-primary"
          ><i class="fas fa-road"></i> <span class="shortcut-key">[T]</span> المسابقة (Tour)</a
        >

        <a href="{{ url_for('index') }}" id="btn-home" class="btn btn-secondary"
          ><i class="fas fa-arrow-left"></i> <span class="shortcut-key">[I]</span> العودة إلى الصفحة الرئيسية</a
        >
        <!-- END: MODIFIED BUTTONS GROUP -->

      </form>
    </div>

    <!-- START: SWAP MODAL -->
    <div class="modal fade" id="quickSwapModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-exchange-alt"></i> تبديل المتنافسين (Q)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            
            <!-- Step 1: Select Competitions -->
            <div id="swap-step-1">
                <h6>المرحلة 1: اختر مسابقتين للتبديل بينهما <span class="shortcut-badge">[Alt+رقم]</span></h6>
                <p class="text-muted small">اختر مسابقتين ثم اضغط Q للمتابعة.</p>
                <div id="modal-competitions-list" style="max-height: 400px; overflow-y: auto;">
                    <!-- سيتم تعبئتها بواسطة JS -->
                </div>
            </div>

            <!-- Step 2: Select Competitors -->
            <div id="swap-step-2" class="step-hidden">
                <h6>المرحلة 2: اختر المتنافسين <span class="shortcut-badge">[1.. يمين] [Alt+1.. يسار]</span></h6>
                <p class="text-muted small">اضغط Q لتنفيذ التبديل.</p>
                <div class="row">
                    <div class="col-md-6">
                        <h6 id="step2-title-1">المسابقة الأولى</h6>
                        <div id="step2-list-1"></div>
                    </div>
                    <div class="col-md-6">
                        <h6 id="step2-title-2">المسابقة الثانية</h6>
                        <div id="step2-list-2"></div>
                    </div>
                </div>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
            <button type="button" class="btn btn-primary" id="btn-modal-action">التالي (Q)</button>
          </div>
        </div>
      </div>
    </div>
    <!-- END: SWAP MODAL -->


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const modeSelect = document.getElementById("mode");
    const valueInput = document.getElementById("valueInput");
    const minMaxInput = document.getElementById("min-max-input");
    const rangeInputs = document.getElementById("range-inputs");
    const timesShownInput = document.getElementById("times-shown-input");
    const tagsModeInput = document.getElementById("tags-mode-input");
    const tournamentFileSelect = document.getElementById("tournament_file");
    const jsonDataTextarea = document.getElementById("json_data");
    const competitionCountSpan = document.getElementById("competition-count");
    // START: MODIFIED SECTION - عنصر عرض الاسم الكامل
    const selectedFileFullNameDiv = document.getElementById("selected-file-full-name");
    // END: MODIFIED SECTION

    const filterBtn = document.getElementById("filter-unplayed-btn");
    const deleteBtn = document.getElementById("delete-tournament-btn");
    const regroupBtn = document.getElementById("regroup-btn");

    const renameFileBtn = document.getElementById("rename-file-btn");
    const renameArchiveBtn = document.getElementById("rename-archive-btn");
    const createArchiveBtn = document.getElementById("create-archive-btn");

    // Modal elements
    const quickSwapModal = new bootstrap.Modal(document.getElementById('quickSwapModal'));
    const modalEl = document.getElementById('quickSwapModal');
    let currentSwapStep = 1;
    let selectedCompetitions = []; // Indices of selected competitions
    let selectedCompetitors = { c1: null, c2: null }; // Indices of selected competitors inside comps
    let currentParsedData = null;

    // START: MODIFIED SECTION - دالة لتحديث عرض الاسم الكامل
    function updateFullFileNameDisplay() {
        const selectedOption = tournamentFileSelect.options[tournamentFileSelect.selectedIndex];
        if (selectedOption && selectedOption.value) {
            selectedFileFullNameDiv.textContent = selectedOption.text;
            selectedFileFullNameDiv.style.display = 'block';
        } else {
            selectedFileFullNameDiv.style.display = 'none';
        }
    }
    // END: MODIFIED SECTION

    function updateFileContent(selectedFile) {
      // START: MODIFIED SECTION - تحديث الاسم عند تغيير المحتوى
      updateFullFileNameDisplay();
      // END: MODIFIED SECTION
      
      if (selectedFile) {
        filterBtn.style.display = "inline-block";
        deleteBtn.style.display = "inline-block";
        regroupBtn.style.display = "inline-block";
        renameFileBtn.style.display = "inline-block";
        renameArchiveBtn.style.display = "inline-block";
        createArchiveBtn.style.display = "inline-block";

        fetch("/get_tournament_content/" + encodeURIComponent(selectedFile))
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.raw_content) {
              try {
                const parsedJson = JSON.parse(data.raw_content);
                document.getElementById("json_data").value = JSON.stringify(
                  parsedJson,
                  null,
                  4
                );
                currentParsedData = parsedJson; // Store for modal
                if (Array.isArray(parsedJson)) {
                  document.getElementById(
                    "competition-count"
                  ).textContent = `إجمالي المسابقات: ${parsedJson.length}`;
                } else {
                  competitionCountSpan.textContent =
                    "المحتوى ليس قائمة مسابقات.";
                }
              } catch (e) {
                document.getElementById("json_data").value = data.raw_content;
                competitionCountSpan.textContent = "المحتوى ليس بصيغة JSON.";
              }
            } else {
              jsonDataTextarea.value = `فشل تحميل المحتوى: ${
                data.message || "خطأ غير معروف"
              }`;
              competitionCountSpan.textContent = "";
            }
          })
          .catch((error) => {
            console.error("Error fetching file content:", error);
            jsonDataTextarea.value = `خطأ في الشبكة: ${error.message}`;
            competitionCountSpan.textContent = "";
          });
      } else {
        filterBtn.style.display = "none";
        deleteBtn.style.display = "none";
        regroupBtn.style.display = "none";
        renameFileBtn.style.display = "none";
        renameArchiveBtn.style.display = "none";
        createArchiveBtn.style.display = "none";

        document.getElementById("json_data").value = "";
        document.getElementById("competition-count").textContent = "";
      }
    }

    tournamentFileSelect.addEventListener("change", function () {
      updateFileContent(this.value);
    });

    if (tournamentFileSelect.value) {
      updateFileContent(tournamentFileSelect.value);
    }

    // --- زر الفلترة ---
    filterBtn.addEventListener("click", function () {
      const selectedFile = tournamentFileSelect.value;
      if (!selectedFile) return;

      this.disabled = true;
      this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جار الفلترة...';

      fetch("/filter_unplayed/" + encodeURIComponent(selectedFile))
        .then((response) => {
          if (!response.ok) {
             return response.json().then((err) => { throw new Error(err.error || err.message); });
          }
          return response.json();
        })
        .then((result) => {
          if (result.status === "completed") {
            updateFileContent(selectedFile);
          } else if (typeof result.data !== "undefined") {
            const filteredData = result.data;
            jsonDataTextarea.value = JSON.stringify(filteredData, null, 4);
            currentParsedData = filteredData;
            competitionCountSpan.textContent = `المسابقات المتبقية: ${filteredData.length}`;
          }
        })
        .catch((error) => console.error(error))
        .finally(() => {
          this.disabled = false;
          this.innerHTML = '<i class="fas fa-filter"></i> <span class="shortcut-key">[C]</span> متابعة';
        });
    });

    // --- زر الحذف (المعدل) ---
    deleteBtn.addEventListener("click", function () {
      const selectedFile = tournamentFileSelect.value;
      if (!selectedFile) return;

      this.disabled = true;
      // حفظ الاندكس الحالي قبل الحذف
      const currentIndex = tournamentFileSelect.selectedIndex;

      fetch("/api/manage_tournament_file", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "delete", filename: selectedFile }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // حذف العنصر من القائمة
            tournamentFileSelect.remove(currentIndex);
            
            // تحديد العنصر التالي (أو الأخير إذا كنا في النهاية)
            let nextIndex = currentIndex;
            if (nextIndex >= tournamentFileSelect.options.length) {
                nextIndex = tournamentFileSelect.options.length - 1;
            }
            
            // إذا بقي عناصر، اختر التالي وحدث المحتوى
            if (nextIndex > 0) {
                tournamentFileSelect.selectedIndex = nextIndex;
                updateFileContent(tournamentFileSelect.value);
            } else {
                // لم يبق شيء
                updateFileContent("");
            }
          } else {
            alert("فشل الحذف: " + data.message);
          }
        })
        .catch((error) => console.error(error))
        .finally(() => { this.disabled = false; });
    });

    // --- زر إعادة التجميع ---
    regroupBtn.addEventListener("click", function () {
      const selectedFile = tournamentFileSelect.value;
      if (!selectedFile) return;
      const newSize = prompt("أدخل العدد الجديد:", "2");
      if (!newSize) return;

      fetch("/regroup_competitions", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename: selectedFile, new_num_videos: parseInt(newSize) }),
      })
      .then(r => r.json())
      .then(d => { if(d.success) updateFileContent(selectedFile); });
    });

    // --- 1. زر إعادة تسمية الملف ---
    renameFileBtn.addEventListener("click", function () {
      const selectedFile = tournamentFileSelect.value;
      if (!selectedFile) return;
      const newName = prompt("اسم جديد للملف:", selectedFile.replace(".json", ""));
      if (newName) {
        fetch("/rename_tournament_file_action", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ old_filename: selectedFile, new_filename: newName + ".json" }),
        }).then(r => r.json()).then(d => { if(d.success) location.reload(); });
      }
    });

    // --- 2. زر إعادة تسمية الأرشيف (المعدل) ---
    renameArchiveBtn.addEventListener("click", function () {
      const selectedFile = tournamentFileSelect.value;
      if (!selectedFile) return;
      const currentKey = selectedFile.replace(".json", "");
      
      // التعديل: النص الافتراضي يبدأ بـ 10.
      const defaultName = "10." + currentKey;
      
      const newName = prompt("أدخل الاسم الجديد لسجل الأرشيف:", defaultName);
      if (newName) {
        fetch("/rename_archive_entry_action", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ filename: selectedFile, new_name: newName.trim() }),
        });
      }
    });

    // --- 3. زر إنشاء أرشيف ---
    createArchiveBtn.addEventListener("click", function () {
      const selectedFile = tournamentFileSelect.value;
      if (!selectedFile) return;
      const p = prompt("عدد المشاركين:", "32");
      if(p) {
        fetch("/create_archive_entry_action", {
          method: "POST", headers: {"Content-Type": "application/json"},
          body: JSON.stringify({filename: selectedFile, participants: parseInt(p)})
        });
      }
    });

    modeSelect.addEventListener("change", function () {
      // إخفاء واظهار الحقول حسب المود (كما في الكود الأصلي)
      valueInput.style.display = "none"; minMaxInput.style.display = "none"; rangeInputs.style.display = "none"; timesShownInput.style.display = "none"; tagsModeInput.style.display = "none";
      document.querySelectorAll("#valueInput input, #min-max-input input, #range-inputs input, #times-shown-input input, #tags-mode-input input").forEach(i => i.required = false);
      if (this.value === "3" || this.value === "4") { valueInput.style.display = "block"; document.getElementById("value").required = true; }
      else if (this.value === "5" || this.value === "6") { minMaxInput.style.display = "block"; document.getElementById("min_value").required = true; document.getElementById("max_value").required = true; }
      else if (this.value === "8") { rangeInputs.style.display = "block"; document.getElementById("min_value1").required = true; }
      else if (this.value === "9") { timesShownInput.style.display = "block"; document.getElementById("min_times_shown").required = true; }
      else if (this.value === "10") { tagsModeInput.style.display = "block"; document.getElementById("tags_value_mode_input").required = true; }
    });
    modeSelect.dispatchEvent(new Event("change"));

    // ==========================================
    //  MODAL LOGIC FOR SWAP (Q)
    // ==========================================
    
    function openSwapModal() {
        // Parse current JSON content
        try {
            const raw = jsonDataTextarea.value;
            if(!raw) return;
            currentParsedData = JSON.parse(raw);
        } catch(e) { return; }

        if(!Array.isArray(currentParsedData)) return;

        currentSwapStep = 1;
        selectedCompetitions = [];
        selectedCompetitors = { c1: null, c2: null };
        
        renderStep1();
        quickSwapModal.show();
    }

    function renderStep1() {
        document.getElementById('swap-step-1').classList.remove('step-hidden');
        document.getElementById('swap-step-2').classList.add('step-hidden');
        document.getElementById('btn-modal-action').textContent = "التالي (Q)";
        
        const list = document.getElementById('modal-competitions-list');
        list.innerHTML = '';
        currentParsedData.forEach((comp, idx) => {
            const div = document.createElement('div');
            div.className = 'competition-select-item';
            div.innerText = `مسابقة ${idx + 1} (${comp.videos.length} فيديوهات)`;
            div.dataset.index = idx;
            div.onclick = () => toggleCompetitionSelect(idx);
            list.appendChild(div);
        });
        updateStep1UI();
    }

    function toggleCompetitionSelect(idx) {
        const i = selectedCompetitions.indexOf(idx);
        if (i > -1) {
            selectedCompetitions.splice(i, 1);
        } else {
            if (selectedCompetitions.length < 2) {
                selectedCompetitions.push(idx);
            } else {
                // If 2 selected, replace the last one
                selectedCompetitions.pop();
                selectedCompetitions.push(idx);
            }
        }
        updateStep1UI();
    }

    function updateStep1UI() {
        const items = document.querySelectorAll('.competition-select-item');
        items.forEach(item => {
            const idx = parseInt(item.dataset.index);
            if(selectedCompetitions.includes(idx)) item.classList.add('selected');
            else item.classList.remove('selected');
        });
    }

    function goToStep2() {
        if(selectedCompetitions.length !== 2) return;
        currentSwapStep = 2;
        document.getElementById('swap-step-1').classList.add('step-hidden');
        document.getElementById('swap-step-2').classList.remove('step-hidden');
        document.getElementById('btn-modal-action').textContent = "تنفيذ التبديل (Q)";
        
        const c1Idx = selectedCompetitions[0];
        const c2Idx = selectedCompetitions[1];
        
        document.getElementById('step2-title-1').innerText = `المسابقة ${c1Idx + 1}`;
        document.getElementById('step2-title-2').innerText = `المسابقة ${c2Idx + 1}`;
        
        renderCompetitorsList(c1Idx, 'step2-list-1', 'c1');
        renderCompetitorsList(c2Idx, 'step2-list-2', 'c2');
    }

    function renderCompetitorsList(compIdx, containerId, key) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        const videos = currentParsedData[compIdx].videos;
        videos.forEach((v, vIdx) => {
            const div = document.createElement('div');
            div.className = 'competitor-item';
            div.innerHTML = `<strong>${vIdx+1}:</strong> <small>${v.substring(0, 30)}...</small>`;
            div.onclick = () => {
                selectedCompetitors[key] = vIdx;
                updateStep2UI();
            };
            if(selectedCompetitors[key] === vIdx) div.style.backgroundColor = '#1f6feb';
            container.appendChild(div);
        });
    }

    function updateStep2UI() {
        // Redraw highlights
        ['c1', 'c2'].forEach(key => {
            const container = document.getElementById(key === 'c1' ? 'step2-list-1' : 'step2-list-2');
            Array.from(container.children).forEach((div, idx) => {
                div.style.backgroundColor = (selectedCompetitors[key] === idx) ? '#1f6feb' : '#21262d';
            });
        });
    }

    function executeSwap() {
        if(selectedCompetitors.c1 === null || selectedCompetitors.c2 === null) return;
        
        const c1Idx = selectedCompetitions[0];
        const c2Idx = selectedCompetitions[1];
        const v1Idx = selectedCompetitors.c1;
        const v2Idx = selectedCompetitors.c2;
        
        const payload = {
            selected_file: tournamentFileSelect.value,
            action: 'swap',
            swap_comp1_index: c1Idx,
            swap_comp1_competitor_index: v1Idx,
            swap_comp2_index: c2Idx,
            swap_comp2_competitor_index: v2Idx
        };
        
        const formData = new FormData();
        for(const k in payload) formData.append(k, payload[k]);
        
        fetch("{{ url_for('manage_tournaments_actions') }}", {
            method: 'POST',
            body: formData
        }).then(response => {
            if(response.ok) {
                quickSwapModal.hide();
                updateFileContent(tournamentFileSelect.value); // تحديث الواجهة
            }
        });
    }
    
    document.getElementById('btn-modal-action').onclick = function() {
        if(currentSwapStep === 1) goToStep2();
        else executeSwap();
    };

    // ==========================================
    //  KEYBOARD SHORTCUTS
    // ==========================================
    document.addEventListener('keydown', function(event) {
        
        const activeTag = document.activeElement.tagName;
        const key = event.key.toLowerCase();
        const tournamentSelect = document.getElementById("tournament_file");

        // 1. Q Shortcut logic
        if (key === 'q') {
            const isModalOpen = modalEl.classList.contains('show');
            
            if (isModalOpen) {
                event.preventDefault();
                document.getElementById('btn-modal-action').click();
                return;
            } else if (activeTag !== 'INPUT' && activeTag !== 'TEXTAREA') {
                event.preventDefault();
                openSwapModal();
                return;
            }
        }

        // Logic INSIDE Modal
        if (modalEl.classList.contains('show')) {
            const isDigit = /^[0-9]$/.test(key);
            if (isDigit) {
                event.preventDefault();
                let num = parseInt(key);
                if (num === 0) num = 10;
                const idx = num - 1;

                if (currentSwapStep === 1) {
                    if (event.altKey) {
                         toggleCompetitionSelect(idx);
                    } else {
                        toggleCompetitionSelect(idx);
                    }
                } else if (currentSwapStep === 2) {
                    if (event.altKey) {
                        selectedCompetitors.c2 = idx;
                    } else {
                        selectedCompetitors.c1 = idx;
                    }
                    updateStep2UI();
                }
            }
            return;
        }

        // ---------------------------------------------------------
        // Standard Shortcuts (Outside Modal)
        // ---------------------------------------------------------
        
        if (key === '`' || key === 'ذ') {
            event.preventDefault();
            if (tournamentSelect) tournamentSelect.focus();
            return;
        }

        if (activeTag !== 'INPUT' && activeTag !== 'TEXTAREA') {
            if (key === '1') {
                event.preventDefault();
                if (tournamentSelect && tournamentSelect.selectedIndex > 0) {
                    tournamentSelect.selectedIndex--;
                    tournamentSelect.dispatchEvent(new Event('change'));
                }
                return;
            }
            if (key === '2') {
                event.preventDefault();
                if (tournamentSelect && tournamentSelect.selectedIndex < tournamentSelect.options.length - 1) {
                    tournamentSelect.selectedIndex++;
                    tournamentSelect.dispatchEvent(new Event('change'));
                }
                return;
            }
        }

        if (['INPUT', 'TEXTAREA', 'SELECT'].includes(activeTag)) return;
        if(document.body.classList.contains('modal-open')) return;

        switch (key) {
            case 'c': // متابعة
                event.preventDefault();
                filterBtn.click();
                break;
            case 's': // بدء المسابقة
                event.preventDefault();
                document.getElementById('btn-start').click();
                break;
            case 'a': // تجميع
                event.preventDefault();
                regroupBtn.click();
                break;
            
            case 'd': // حذف (المعدل)
                event.preventDefault();
                if (deleteBtn && deleteBtn.style.display !== 'none') deleteBtn.click();
                break;

            case 'z': // الرئيسية
                event.preventDefault();
                document.getElementById('btn-home').click();
                break;

            case 't': // Tour
                event.preventDefault();
                document.getElementById('btn-tour').click();
                break;

            // R: الآن مخصص لزر الأرشيف حسب الطلب
            case 'r': 
                event.preventDefault();
                if (renameArchiveBtn && renameArchiveBtn.style.display !== 'none') {
                    renameArchiveBtn.click();
                }
                break;
        }
    });
  });
</script>
  </body>
</html>