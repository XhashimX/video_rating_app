<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>لوحة التحكم والترتيب</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
      body {
        background-color: #121212;
        color: #e0e0e0;
        font-family: "Cairo", sans-serif;
      }
      .card { background-color: #1e1e1e; border: 1px solid #333; }
      .table-dark { background-color: #1e1e1e; --bs-table-bg: #1e1e1e; }
      .change-up { color: #00ff00; font-weight: bold; }
      .change-down { color: #ff3333; font-weight: bold; }
      .change-neutral { color: #888; }
      
      .rank-circle {
        display: inline-block;
        width: 35px; height: 35px; line-height: 35px;
        border-radius: 50%; text-align: center;
        background: #333; font-weight: bold; font-size: 0.9em;
      }
      .rank-1 { background: #ffd700; color: #000; box-shadow: 0 0 10px #ffd700; }
      .rank-2 { background: #c0c0c0; color: #000; }
      .rank-3 { background: #cd7f32; color: #000; }

      .bet-input {
        background: #2a2a2a; border: 1px solid #444; color: white;
        width: 70px; text-align: center;
      }
      
      .btn-play {
        width: 40px; height: 40px; border-radius: 50%;
        padding: 0; display: flex; align-items: center; justify-content: center;
        background-color: rgba(32, 201, 151, 0.2);
        color: #20c997; border: 1px solid #20c997;
        transition: all 0.3s;
      }
      .btn-play:hover {
        background-color: #20c997; color: white; transform: scale(1.1);
      }
      
      .range-input {
          width: 80px; text-align: center; 
          background: #333; color: white; border: 1px solid #555;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      
      <!-- رسائل التنبيه -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- الهيدر -->
      <div class="row mb-4 align-items-center">
        <div class="col-md-6">
          <h1><i class="fas fa-chart-line text-success"></i> لوحة المتصدرين</h1>
        </div>
        <div class="col-md-6 text-end">
            <a href="{{ url_for('index') }}" class="btn btn-secondary me-2">الرئيسية</a>
            
            <form action="{{ url_for('save_snapshot_action') }}" method="POST" class="d-inline">
                <!-- الحفاظ على الفلاتر -->
                <input type="hidden" name="return_filter" value="{{ current_filter }}">
                <input type="hidden" name="return_search" value="{{ search_query }}">
                <input type="hidden" name="start_rank" value="{{ current_start }}">
                <input type="hidden" name="end_rank" value="{{ current_end }}">
                
                <button type="submit" class="btn btn-warning" onclick="return confirm('هل تريد اعتماد الترتيب الحالي كمرجع للمقارنة؟')">
                    <i class="fas fa-save"></i> حفظ نقطة مرجعية
                </button>
            </form>
        </div>
      </div>

      <!-- أدوات التحكم والفلترة -->
      <div class="card mb-4 p-3">
        
        <div class="d-flex justify-content-between flex-wrap gap-2 mb-3">
            <!-- أزرار الفلتر -->
            <div class="btn-group" role="group">
                <a href="{{ url_for('dashboard', filter='all', start_rank=current_start, end_rank=current_end) }}" class="btn {{ 'btn-primary' if current_filter == 'all' else 'btn-outline-secondary' }}">
                    الكل
                </a>
                <a href="{{ url_for('dashboard', filter='bets_only', start_rank=current_start, end_rank=current_end) }}" class="btn {{ 'btn-warning' if current_filter == 'bets_only' else 'btn-outline-warning' }}">
                    <i class="fas fa-crosshairs"></i> المراهنات النشطة
                </a>
            </div>

            <!-- قائمة إجراءات الرهان بالجملة -->
            <div class="dropdown">
                <button class="btn btn-danger dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-trash-alt"></i> إدارة الرهانات
                </button>
                <ul class="dropdown-menu dropdown-menu-dark">
                    <li>
                        <form action="{{ url_for('delete_bulk_bets') }}" method="POST">
                            <input type="hidden" name="action_type" value="delete_active">
                            <input type="hidden" name="return_filter" value="{{ current_filter }}">
                            <input type="hidden" name="return_search" value="{{ search_query }}">
                            <input type="hidden" name="start_rank" value="{{ current_start }}">
                            <input type="hidden" name="end_rank" value="{{ current_end }}">
                            <button class="dropdown-item text-warning" type="submit" onclick="return confirm('هل أنت متأكد من حذف جميع الرهانات النشطة؟')">
                                <i class="fas fa-eraser"></i> حذف كل الرهانات النشطة
                            </button>
                        </form>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <form action="{{ url_for('delete_bulk_bets') }}" method="POST">
                            <input type="hidden" name="action_type" value="delete_completed">
                            <input type="hidden" name="return_filter" value="{{ current_filter }}">
                            <input type="hidden" name="return_search" value="{{ search_query }}">
                            <input type="hidden" name="start_rank" value="{{ current_start }}">
                            <input type="hidden" name="end_rank" value="{{ current_end }}">
                            <button class="dropdown-item text-danger" type="submit" onclick="return confirm('هل أنت متأكد من حذف سجل الرهانات المنتهية؟')">
                                <i class="fas fa-history"></i> حذف سجل المنتهية
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>

        <div class="row g-3 align-items-center">
            <!-- نموذج البحث -->
            <div class="col-md-5">
                <form method="GET" class="d-flex gap-2">
                    <input type="hidden" name="filter" value="{{ current_filter }}">
                    <input type="hidden" name="start_rank" value="{{ current_start }}">
                    <input type="hidden" name="end_rank" value="{{ current_end }}">
                    
                    <input type="text" name="search" class="form-control bg-dark text-white border-secondary" 
                           placeholder="بحث بالاسم أو الحجم..." 
                           value="{{ search_query }}">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i></button>
                    {% if search_query %}
                        <a href="{{ url_for('dashboard', filter=current_filter, start_rank=current_start, end_rank=current_end) }}" class="btn btn-outline-secondary">إلغاء</a>
                    {% endif %}
                </form>
            </div>

            <!-- نموذج العرض والمجال المخصص -->
            <div class="col-md-7">
                {% if not search_query and current_filter != 'bets_only' %}
                <div class="d-flex justify-content-end gap-3 flex-wrap">
                    <!-- خيارات سريعة -->
                    <form method="POST" class="d-flex align-items-center gap-2">
                        <input type="hidden" name="return_filter" value="{{ current_filter }}">
                        <select name="limit" class="form-select bg-dark text-white border-secondary form-select-sm w-auto" onchange="this.form.submit()">
                            <option value="" disabled selected>عرض سريع...</option>
                            <option value="32">أفضل 32</option>
                            <option value="64">أفضل 64</option>
                            <option value="128">أفضل 128</option>
                            <option value="500">أفضل 500</option>
                        </select>
                    </form>
                    
                    <!-- المجال المخصص -->
                    <form method="GET" class="d-flex align-items-center gap-2 bg-dark border border-secondary p-1 rounded">
                        <input type="hidden" name="filter" value="{{ current_filter }}">
                        <span class="text-muted small">من:</span>
                        <input type="number" name="start_rank" class="form-control form-control-sm range-input" value="{{ current_start }}" min="1">
                        <span class="text-muted small">إلى:</span>
                        <input type="number" name="end_rank" class="form-control form-control-sm range-input" value="{{ current_end }}" min="1">
                        <button type="submit" class="btn btn-sm btn-info"><i class="fas fa-arrow-right"></i> عرض</button>
                    </form>
                </div>
                {% elif current_filter == 'bets_only' %}
                     <div class="text-end"><span class="badge bg-warning text-dark fs-6">نمط عرض الرهانات</span></div>
                {% else %}
                    <div class="text-end"><span class="badge bg-info text-dark fs-6">نتائج البحث</span></div>
                {% endif %}
            </div>
        </div>
      </div>

      <!-- جدول النتائج -->
      <div class="table-responsive">
        <table class="table table-dark table-hover align-middle">
            <thead>
                <tr>
                    <th class="text-center" width="80">الترتيب</th>
                    <th width="60">تشغيل</th>
                    <th>الفيديو</th>
                    <th class="text-center">التقييم</th>
                    <th class="text-center">الحجم</th>
                    <th class="text-center">التغيير</th>
                    <th class="text-center">السابق</th>
                    <th class="text-center">المراهنة</th>
                </tr>
            </thead>
            <tbody>
                {% for vid in videos %}
                <tr>
                    <!-- الترتيب -->
                    <td class="text-center">
                        <span class="rank-circle rank-{{ vid.rank }}">
                            {{ vid.rank }}
                        </span>
                    </td>
                    
                    <!-- زر التشغيل -->
                    <td class="text-center">
                        <button class="btn btn-play" 
                                onclick="openVideoModal('{{ vid.filename|quote }}', '{{ vid.display_name|e }}')">
                            <i class="fas fa-play"></i>
                        </button>
                    </td>
                    
                    <!-- الاسم -->
                    <td>
                        <div class="fw-bold text-white">{{ vid.display_name }}</div>
                        <div class="small text-muted" style="font-size: 0.8em;">{{ vid.filename }}</div>
                    </td>
                    
                    <!-- التقييم -->
                    <td class="text-center text-info fw-bold">
                        {{ "%.2f"|format(vid.rating) }}
                    </td>
                    
                    <!-- الحجم -->
                    <td class="text-center text-muted small">
                        {{ vid.file_size }}
                    </td>
                    
                    <!-- التغيير -->
                    <td class="text-center">
                        {% if vid.change == 'new' %}
                            <span class="badge bg-primary">جديد</span>
                        {% elif vid.change > 0 %}
                            <span class="change-up"><i class="fas fa-arrow-up"></i> {{ vid.change }}</span>
                        {% elif vid.change < 0 %}
                            <span class="change-down"><i class="fas fa-arrow-down"></i> {{ vid.change|abs }}</span>
                        {% else %}
                            <span class="change-neutral">-</span>
                        {% endif %}
                    </td>
                    
                    <!-- السابق -->
                    <td class="text-center text-muted">{{ vid.prev_rank }}</td>

                    <!-- المراهنة -->
                    <td class="text-center">
                        {% if vid.bet %}
                            {% if vid.bet.status == 'completed' %}
                                <span class="badge bg-success"><i class="fas fa-check"></i> ({{ vid.bet.target_rank }})</span>
                                <form action="{{ url_for('delete_bet_action') }}" method="POST" class="d-inline">
                                    <input type="hidden" name="video_name" value="{{ vid.filename }}">
                                    <!-- الحفاظ على الفلاتر -->
                                    <input type="hidden" name="return_filter" value="{{ current_filter }}">
                                    <input type="hidden" name="return_search" value="{{ search_query }}">
                                    <input type="hidden" name="start_rank" value="{{ current_start }}">
                                    <input type="hidden" name="end_rank" value="{{ current_end }}">
                                    
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="حذف الرهان"><i class="fas fa-trash"></i></button>
                                </form>
                            {% else %}
                                <span class="badge bg-warning text-dark">{{ vid.bet.target_rank }}</span>
                                <form action="{{ url_for('start_bet_match') }}" method="POST" class="d-inline">
                                    <input type="hidden" name="video_name" value="{{ vid.filename }}">
                                    <button type="submit" class="btn btn-sm btn-primary fw-bold" title="بدء التحدي الآن">VS</button>
                                </form>
                                <form action="{{ url_for('delete_bet_action') }}" method="POST" class="d-inline">
                                    <input type="hidden" name="video_name" value="{{ vid.filename }}">
                                    
                                    <!-- الحفاظ على الفلاتر -->
                                    <input type="hidden" name="return_filter" value="{{ current_filter }}">
                                    <input type="hidden" name="return_search" value="{{ search_query }}">
                                    <input type="hidden" name="start_rank" value="{{ current_start }}">
                                    <input type="hidden" name="end_rank" value="{{ current_end }}">
                                    
                                    <button type="submit" class="btn btn-sm btn-outline-secondary" title="إلغاء الرهان"><i class="fas fa-times"></i></button>
                                </form>
                            {% endif %}
                        {% else %}
                            <form action="{{ url_for('place_bet') }}" method="POST">
                                <input type="hidden" name="video_name" value="{{ vid.filename }}">
                                
                                <!-- الحفاظ على الفلاتر -->
                                <input type="hidden" name="return_filter" value="{{ current_filter }}">
                                <input type="hidden" name="return_search" value="{{ search_query }}">
                                <input type="hidden" name="start_rank" value="{{ current_start }}">
                                <input type="hidden" name="end_rank" value="{{ current_end }}">
                                
                                <div class="input-group input-group-sm justify-content-center">
                                    <input type="number" name="target_rank" class="form-control bet-input" placeholder="الهدف" min="1" required>
                                    <button type="submit" class="btn btn-success"><i class="fas fa-crosshairs"></i></button>
                                </div>
                            </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% if videos|length == 0 %}
            <div class="alert alert-warning text-center">لا توجد بيانات للعرض حالياً ضمن هذا النطاق أو البحث.</div>
        {% endif %}
      </div>
      
    </div>

    <!-- Video Modal -->
    <div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-secondary">
          <div class="modal-header border-secondary">
            <h5 class="modal-title" id="videoModalLabel">مشاهدة الفيديو</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-0">
            <div class="ratio ratio-16x9">
                <video id="modalVideoPlayer" controls>
                    Your browser does not support the video tag.
                </video>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const videoModal = document.getElementById('videoModal');
        const videoPlayer = document.getElementById('modalVideoPlayer');
        const modalTitle = document.getElementById('videoModalLabel');

        function openVideoModal(encodedFilename, displayName) {
            const filename = decodeURIComponent(encodedFilename);
            const videoUrl = "{{ url_for('serve_video', filename='') }}" + encodedFilename;
            
            modalTitle.textContent = displayName;
            videoPlayer.src = videoUrl;
            
            const modalInstance = new bootstrap.Modal(videoModal);
            modalInstance.show();
            
            videoPlayer.play().catch(e => console.log("Auto-play prevented"));
        }

        videoModal.addEventListener('hidden.bs.modal', function () {
            videoPlayer.pause();
            videoPlayer.src = "";
        });
    </script>
  </body>
</html>